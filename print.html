<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Feakin - 软件开发工业化 DSL</title>
        <meta name="robots" content="noindex" />
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="index.html">关于 Feakin</a></li><li class="chapter-item expanded affix "><a href="quick-start.html">如何使用</a></li><li class="chapter-item expanded affix "><a href="design-principles.html">Feakin 设计理念</a></li><li class="chapter-item expanded affix "><li class="part-title">User Guide</li><li class="chapter-item expanded "><a href="guide/chapter_1.html"><strong aria-hidden="true">1.</strong> 使用 Feakin 进行战略设计</a></li><li class="chapter-item expanded "><a href="guide/chapter_2.html"><strong aria-hidden="true">2.</strong> 实现 DDD 的战术设计 </a></li><li class="chapter-item expanded "><a href="guide/chapter_3.html"><strong aria-hidden="true">3.</strong> 基于上下文映射与绑定的代码生成</a></li><li class="chapter-item expanded "><a href="guide/chapter_4.html"><strong aria-hidden="true">4.</strong> 软件架构守护</a></li><li class="chapter-item expanded "><a href="guide/chapter_5.html"><strong aria-hidden="true">5.</strong> 契约驱动的 HTTP API 测试</a></li><li class="chapter-item expanded "><a href="guide/chapter_6.html"><strong aria-hidden="true">6.</strong> Mock Server</a></li><li class="chapter-item expanded "><a href="guide/chapter_7.html"><strong aria-hidden="true">7.</strong> 基础设施绑定与环境变量</a></li><li class="chapter-item expanded affix "><li class="part-title">Reference Guide</li><li class="chapter-item expanded "><a href="fklang/specification.html"><strong aria-hidden="true">8.</strong> Fklang Specification</a></li><li class="chapter-item expanded affix "><li class="part-title">开发指南</li><li class="chapter-item expanded "><a href="development/index.html"><strong aria-hidden="true">9.</strong> Development Guide</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="development/setup.html"><strong aria-hidden="true">9.1.</strong> Setup</a></li></ol></li><li class="chapter-item expanded "><a href="development/collaboration.html"><strong aria-hidden="true">10.</strong> Collaboration</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="development/collaboration-crdt.html"><strong aria-hidden="true">10.1.</strong> CRDT</a></li></ol></li><li class="chapter-item expanded "><a href="development/graph.html"><strong aria-hidden="true">11.</strong> Graph</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="development/graph-gim.html"><strong aria-hidden="true">11.1.</strong> GIM</a></li><li class="chapter-item expanded "><a href="development/graph-exporter.html"><strong aria-hidden="true">11.2.</strong> Exporter</a></li><li class="chapter-item expanded "><a href="development/graph-render.html"><strong aria-hidden="true">11.3.</strong> Render</a></li></ol></li><li class="chapter-item expanded "><a href="fklang/fklang.html"><strong aria-hidden="true">12.</strong> Fklang</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="fklang/fklang-parser.html"><strong aria-hidden="true">12.1.</strong> Fklang Parser</a></li><li class="chapter-item expanded "><a href="fklang/fklang-code-gen.html"><strong aria-hidden="true">12.2.</strong> Fklang Code Generator</a></li><li class="chapter-item expanded "><a href="fklang/fklang-code-binding.html"><strong aria-hidden="true">12.3.</strong> Fklang Binding</a></li><li class="chapter-item expanded "><a href="fklang/fklang-build-system.html"><strong aria-hidden="true">12.4.</strong> Fklang Build System</a></li></ol></li><li class="chapter-item expanded "><a href="development/intellij-plugin.html"><strong aria-hidden="true">13.</strong> Intellij Plugin</a></li><li class="chapter-item expanded "><a href="development/monaco-editor.html"><strong aria-hidden="true">14.</strong> Monaco Editor</a></li><li class="chapter-item expanded affix "><li class="part-title">FAQ</li><li class="chapter-item expanded "><a href="faq/index.html"><strong aria-hidden="true">15.</strong> FAQ</a></li><li class="spacer"></li><li class="chapter-item expanded affix "><a href="misc/contributors.html">Contributors</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Feakin - 软件开发工业化 DSL</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/feakin/book" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="feakin---软件开发工业化方法"><a class="header" href="#feakin---软件开发工业化方法">Feakin - 软件开发工业化方法</a></h1>
<p><img src="images/logo.svg" alt="" /></p>
<p>Feakin 是一个软件开发工业化（软件架构设计与开发标准化）方法，基于 DDD （领域驱动设计）与 <a href="https://zhuanlan.zhihu.com/p/341089716">TypeFlow</a> 编程思想。</p>
<p><img src="../images/design-principles.svg" alt="Design Principles" /></p>
<p>核心设计理念：</p>
<ol>
<li>架构孪生：双态绑定。提供架构设计态与实现态的双向绑定，保证架构设计与实现的一致性。 </li>
<li>显性化设计意图。将软件设计的意图化，借助于 DSL 语言的特性，将意图转换化代码。</li>
<li>类型与事件驱动。通过事件驱动的方式，将数据类型与领域事件进行绑定。</li>
</ol>
<p>详细见：《<a href="/design-principles.html">Design Principles</a> 一节》</p>
<p>Feakin 主要组成部分：</p>
<ul>
<li>Fklang 是一个基于软件开发工业化思想，设计的架构设计 DSL。以确保软件系统描述与实现的一致性。通过显式化的软件架构设计，用于支持 AI 代码生成系统的嵌入。</li>
<li>Intellij Plugin 是 Feakin 的一个 IntelliJ 插件，用于将 Feakin/Fklang 集成到项目中。</li>
<li>（Todo） Vscode Plugin 是 Feakin 的一个 Vscode 插件，用于将 Feakin/Fklang 集成到项目中。</li>
<li>Feakin Web 提供了一个架构设计与可视化协作工具，让架构师能够更加高效地进行架构设计与可视化协作。</li>
</ul>
<h2 id="feakin-intellij-plugin"><a class="header" href="#feakin-intellij-plugin">Feakin IntelliJ Plugin</a></h2>
<p>安装：<a href="https://plugins.jetbrains.com/plugin/20026-feakin"><img src="https://img.shields.io/jetbrains/plugin/v/20026-feakin.svg" alt="Version" /></a></p>
<p><img src="../images/feakin-intellij-plugin.png" alt="Feakin Impl Sample" /></p>
<p>Fklang 示例：</p>
<pre><code class="language-feakin">// DDD 上下文映射图
ContextMap TicketBooking {
    Reservation -&gt; Cinema;
    Reservation -&gt; Movie;
    Reservation -&gt; User;
}

Context Reservation {
  Aggregate Reservation;
}

Context Cinema {
  Aggregate Cinema;
}

Aggregate Cinema {
  Entity Cinema, ScreeningRoom, Seat;
}

// DDD 领域事件
impl CinemaCreated {
    endpoint {
        // API 声明与验证
        GET &quot;/book/{id}&quot;;
        authorization: Basic admin admin;
        response: Cinema;
    }
}
</code></pre>
<h2 id="feakin-web"><a class="header" href="#feakin-web">Feakin Web</a></h2>
<p>在线地址：<a href="https://online.feakin.com/">https://online.feakin.com/</a></p>
<p>点击 <code>TEAMPLATES</code> -&gt; <code>Feakin Sample</code> 查看示例</p>
<p><img src="images/feakin-web.png" alt="Feakin Web" /></p>
<h2 id="fklang"><a class="header" href="#fklang">Fklang</a></h2>
<p>下载地址：<a href="https://github.com/feakin/fklang/releases">https://github.com/feakin/fklang/releases</a></p>
<pre><code class="language-bash">Usage: fkl &lt;COMMAND&gt;

Commands:
  gen    Generate code from a fkl file, current support Java
  dot    Generate dot file from a fkl file
  parse  Parse a fkl file and print the AST
  help   Print this message or the help of the given subcommand(s)

Options:
  -h, --help  Print help information
</code></pre>
<p>CLI 示例：</p>
<pre><code class="language-bash">fkl gen --main /Users/phodal/IdeaProjects/untitled/simple.fkl --impl CinemaCreated
</code></pre>
<pre><code class="language-java">@GetMapping(&quot;/book/{id}&quot;)
public Cinema creatCinema() { }
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="quick-start"><a class="header" href="#quick-start">Quick Start</a></h1>
<ol>
<li>安装 Feakin Intellij 插件: <a href="https://plugins.jetbrains.com/plugin/20026-feakin"><img src="https://img.shields.io/jetbrains/plugin/v/20026-feakin.svg" alt="Version" /></a></li>
<li>下载 FKL Cli（SDK）：<a href="https://github.com/feakin/fklang/releases">https://github.com/feakin/fklang/releases</a>
<ul>
<li>重命名为 fkl（macOS 下为 fkl-macos, Windows 下为 fkl-windows.exe, ...），并将其放置到 PATH 中</li>
<li>添加可执行权限：<code>chmod +x fkl</code>
<ul>
<li>遇到 &quot;cannot be opened because the developer cannot be verified.&quot;，参考 <a href="https://support.apple.com/zh-cn/HT202491">https://support.apple.com/zh-cn/HT202491</a></li>
</ul>
</li>
<li>检查 CLI 是否安装成功：<code>fkl --help</code></li>
</ul>
</li>
<li>创建一个 FKL 文件，比如：<code>cinema.fkl</code>，添加如下代码：</li>
</ol>
<pre><code class="language-feakin">impl CinemaCreated {
    endpoint {
        GET &quot;/book/{id}&quot;;
        authorization: Basic admin admin;
        response: Cinema;
    }
}

impl CinemaUpdated {
   endpoint {
      POST &quot;/book/{id}&quot;;
      request: CinemaUpdatedRequest;
      authorization: Basic admin admin;
      response: Cinema;
   }

   flow {
      via UserRepository::getUserById receive user: User
      via UserRepository::save(user: User) receive user: User;
      via MessageQueue send CinemaCreated to &quot;CinemaCreated&quot;
   }
}
</code></pre>
<ol start="4">
<li>在 Intellij IDE 中打开 FKL 文件，点击左侧的 <code>Run</code> 按钮，查看是否有如下输出：</li>
</ol>
<p><img src="../images/feakin-intellij-plugin.png" alt="Feakin Impl Sample" /></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="设计理念软件开发工业化"><a class="header" href="#设计理念软件开发工业化">设计理念：软件开发工业化</a></h1>
<p>Feakin 的核心三个设计思念是：</p>
<ol>
<li>架构孪生：双态绑定。提供架构设计态与实现态的双向绑定，保证架构设计与实现的一致性。</li>
<li>显性化设计意图。将软件设计的意图化，借助于 DSL 语言的特性，将意图转换化代码。</li>
<li>类型与事件驱动。通过事件驱动的方式，将数据类型与领域事件进行绑定。</li>
</ol>
<p>Feakin 作为架构设计态与实现代码的中间语言，如下图所示：</p>
<p><img src="../images/design-principles.svg" alt="Design Principles" /></p>
<p>在实现上便是，通过声明式 DSL 来绑定代码实现与架构设计，保证架构设计与实现的一致性。</p>
<h2 id="架构孪生双态绑定"><a class="header" href="#架构孪生双态绑定">架构孪生：双态绑定</a></h2>
<p>在治理架构时，我们（<a href="https://archguard.org/">ArchGuard</a> 开发团队）推荐采用三态治理的方式，即设计态、实现态和运行态。 而在实现 Feakin 时，则是关注于如何实现设计态与实现态的绑定，我们将这个理念称为 &quot;架构孪生&quot;。</p>
<blockquote>
<p>架构孪生是一种旨在精确反映架构设计的虚拟模型，它以数字化的形式对软件的架构、代码模型、分层、实现技术等的进行动态的呈现。</p>
</blockquote>
<p>在架构生命周期的早期实施数字孪生允许在每个阶段模拟新代码和设计变化，以优化系统的架构。架构模型是可持续建设和运营中使用的架构孪生策略的关键组成部分。</p>
<p>为了实现这样的技术，我们需要面对几个挑战：</p>
<ul>
<li>架构建模：架构的功能、特性和行为。</li>
<li>模型实现：</li>
<li>生命周期：</li>
</ul>
<p>除此，还有一个非常有意思的问题：</p>
<ul>
<li>如何针对于新的需求，动态模拟软件的架构演进，以发现潜在的架构瓶颈？</li>
</ul>
<p>PS：既然如此，那么模拟态也应该成为 Feakin 设计的一个要点。</p>
<h3 id="双态绑定设计态--实现态"><a class="header" href="#双态绑定设计态--实现态">双态绑定：设计态 + 实现态</a></h3>
<ul>
<li>设计态。以 DDD 战略、战术作为基本的设计框架</li>
<li>实现态。以架构扫描作为基本点。</li>
</ul>
<h3 id="生命周期模型"><a class="header" href="#生命周期模型">生命周期模型</a></h3>
<p>关注于：</p>
<ul>
<li>设计态模型。</li>
<li>实现态模型。</li>
<li>模板态/未来态模型。</li>
</ul>
<h3 id="架构因子"><a class="header" href="#架构因子">架构因子</a></h3>
<p>另外一个核心问题便是，如何定义这里的 &quot;架构模型&quot;，以及设计对应的工具，诸如于：TwinDesign、Arch Twin？所以，应该由 CodeDB/ArchDB 来实现。</p>
<p>在构建数字孪生时，我们会给研究对象（例如，风力涡轮机）配备与重要功能方面相关的各种传感器。同样的在构建架构孪生时，我们也需要一系列的 &quot;传感器&quot; 来测量研究对象的各种属性。</p>
<p>也因此，我们也可以定义三种形态的 &quot;传感器&quot; ：</p>
<ul>
<li>设计时 - 架构描述性传感器：描述性传感器用于描述架构的功能、特性和行为。</li>
<li>开发时 - 静态量化传感器：静态量化传感器用于描述架构的实现技术。</li>
<li>运行时 - 探针（probe）：探针用于描述架构的运行时行为。</li>
</ul>
<h2 id="类型与事件驱动"><a class="header" href="#类型与事件驱动">类型与事件驱动</a></h2>
<p>在设计理念中，我们将代码逻辑分为两个部分：<strong>状态</strong>和<strong>行为</strong>。状态是指数据，行为是指数据的操作。在我们的设计中，状态和行为是分离的，状态是不可变的，行为是可变的。这种设计的好处是，我们可以在不同的状态之间进行切换，而不需要重新创建行为。这种设计的缺点是，我们需要在状态和行为之间进行绑定，这样才能保证状态和行为的一致性。 对应实现上，状态既是类型，行为视为事件。</p>
<blockquote>
<p>在数学里，一个函数就是一组输入与一组容许的输出之间的关系，并且每个输入都与唯一一个输出相对应。 —— 维基百科</p>
</blockquote>
<p>意识着，函数是应该是无状态的 —— 输入确定，输出就是确定的。</p>
<p>如何内置记忆（memoization）属性是，我们在设计的时候，要考虑的因素。它可以帮助我们提升性能，但是也会带来一些副作用。</p>
<h3 id="纯函数"><a class="header" href="#纯函数">纯函数</a></h3>
<p>《函数响应式领域建模》中的 Scala 示例：</p>
<pre><code class="language-scala">trait Account {
  def name: String
  def balance: BigDecimal
}

case class OpenedAccount(..) extends Account

trait InterestBearingAccount extends Account {
  def interestRate: BigDecimal
}

case class SavingAccount(..) extends InterestBearingAccount
case class MoenyMarketAccount(..) extends InterestBearingAccount

trait AccountService {
  def calculateInterest(..): BigDecimal
}
</code></pre>
<h3 id="事件驱动"><a class="header" href="#事件驱动">事件驱动</a></h3>
<p>领域事件是不可变的，它是我们在实现的过程中，对领域的抽象。</p>
<h2 id="显性化设计意图"><a class="header" href="#显性化设计意图">显性化设计意图</a></h2>
<h3 id="声明式编程"><a class="header" href="#声明式编程">声明式编程</a></h3>
<p>声明式编程（英语：Declarative programming）是一种编程范式，与命令式编程相对立。 它描述目标的性质，让计算机明白目标，而非流程。</p>
<h3 id="显性化子任务"><a class="header" href="#显性化子任务">显性化子任务</a></h3>
<pre><code class="language-feakin">impl CinemaUpdated {
   ...
   flow {
      via UserRepository::getUserById receive user: User
      via UserRepository::save(user: User) receive user: User;
   }
}
</code></pre>
<h3 id="ai-意图分析"><a class="header" href="#ai-意图分析">AI 意图分析</a></h3>
<p>生成 API</p>
<pre><code class="language-kotlin">// create spring api POST &quot;/user/{id}&quot; with response: User
@RestController
@RequestMapping(&quot;/user&quot;)
class UserController {
    @PostMapping(&quot;/{id}&quot;)
    fun getUserById(@PathVariable id: String): User {
        return User()
    }
}
</code></pre>
<p>如下的代码是，我们借助于 AI 生成的 Java 代码示例：</p>
<pre><code class="language-java">// via UserRepository::getUserById receive user: User
User user = userRepository.getUserById();
// via UserRepository::save(user: User) receive user: User;
User user = userRepository.save(user);
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="ddd-in-feakin"><a class="header" href="#ddd-in-feakin">DDD in Feakin</a></h1>
<p>Feakin 的 DDD 语法参考了：<a href="https://contextmapper.org/docs/context-map/">https://contextmapper.org/docs/context-map/</a></p>
<p>Feakin 语法可以实现三个阶段：</p>
<ul>
<li>战略设计。语法：<code>ContextMap</code>、<code>Context</code></li>
<li>战术设计。语法：<code>Aggregate</code>、<code>Entity</code>、<code>ValueObject</code></li>
<li>实现。语法：<code>impl</code></li>
</ul>
<h2 id="quick-start-1"><a class="header" href="#quick-start-1">Quick Start</a></h2>
<ol>
<li>在线编辑器：<a href="https://online.feakin.com/">https://online.feakin.com/</a></li>
<li>在 <code>Template</code> -&gt; <code>DDD Booking</code> 使用 Feakin 语法设计</li>
</ol>
<pre><code class="language-feakin">ContextMap TicketBooking {
    Reservation -&gt; Cinema;
    Reservation -&gt; Movie;
    Reservation -&gt; User;
}

Context Reservation {
  Aggregate Reservation;
}

Context Cinema {
  Aggregate Cinema;
}

Aggregate Cinema {
  Entity Cinema, ScreeningRoom, Seat;
}
</code></pre>
<p>生成如下图所示的结果：</p>
<p><img src="guide/../images/basic.svg" alt="Basic Demo" /></p>
<p>详细过程：</p>
<ol>
<li>Fklang 编译器会转义 fkl 为 Dot 语法 </li>
<li>Feakin Render 渲染 Dot 语法</li>
</ol>
<p>生成的 DOT 代码如下所示：</p>
<pre><code class="language-dot">digraph TicketBooking2 {
  component=true;layout=fdp;
  node [shape=box style=filled];
  cluster_reservation -&gt; cluster_cinema;
  cluster_reservation -&gt; cluster_movie;
  cluster_reservation -&gt; cluster_user;

  subgraph cluster_cinema {
    label=&quot;Cinema(Context)&quot;;

    subgraph cluster_aggregate_cinema {
      label=&quot;Cinema(Aggregate)&quot;;
      entity_Cinema [label=&quot;Cinema&quot;];
      entity_ScreeningRoom [label=&quot;ScreeningRoom&quot;];
      entity_Seat [label=&quot;Seat&quot;];
    }
  }

  subgraph cluster_movie {
    label=&quot;Movie(Context)&quot;;
  }

  subgraph cluster_reservation {
    label=&quot;Reservation(Context)&quot;;

    subgraph cluster_aggregate_reservation {
      label=&quot;Reservation(Aggregate)&quot;;
    }
  }

  subgraph cluster_user {
    label=&quot;User(Context)&quot;;
  }
}
</code></pre>
<h2 id="ddd-strategy"><a class="header" href="#ddd-strategy">DDD Strategy</a></h2>
<h3 id="step-1-design-context-map"><a class="header" href="#step-1-design-context-map">Step 1. Design Context Map</a></h3>
<p>表示领域上下文图，用于描述系统的边界。</p>
<pre><code class="language-feakin">ContextMap TicketBooking {
  Reservation -&gt; Cinema;
  Reservation -&gt; Movie;
  Reservation -&gt; User;
}
</code></pre>
<p>关系：</p>
<ul>
<li><code>-</code> - Undirected,</li>
<li><code>-&gt;</code> - PositiveDirected,</li>
<li><code>&lt;-</code> - NegativeDirected,</li>
<li><code>&lt;-&gt;</code> - BiDirected,</li>
</ul>
<h3 id="step-2-context"><a class="header" href="#step-2-context">Step 2. Context</a></h3>
<p>表示限界上下文，以及对应的聚合间的关系。</p>
<pre><code class="language-feakin">Context Reservation {
  Aggregate Reservation;
}
</code></pre>
<h2 id="ddd-tactics"><a class="header" href="#ddd-tactics">DDD tactics</a></h2>
<h3 id="step-1-domainobject"><a class="header" href="#step-1-domainobject">Step 1. DomainObject</a></h3>
<p>表示领域对象，包括：聚合、实体、值对象。</p>
<pre><code class="language-feakin">Aggregate Reservation {
  Entity Ticket, Reservation;
}
</code></pre>
<pre><code class="language-feakin">Entity Reservation  {
  
}
</code></pre>
<h2 id="附录在线示例代码"><a class="header" href="#附录在线示例代码">附录：在线示例代码</a></h2>
<pre><code>ContextMap TicketBooking {
  Reservation -&gt; Cinema;
  Reservation -&gt; Movie;
  Reservation -&gt; User;
}

Context Reservation {
  Aggregate Reservation;
}

Aggregate Reservation {
  Entity Ticket, Reservation;
}

Entity Reservation  {}

Entity Ticket  {}

Context Cinema {
  Aggregate Cinema;
}

Aggregate Cinema {
  Entity Cinema, ScreeningRoom, Seat;
}

Entity Cinema { }
Entity ScreeningRoom { }
Entity Seat { }

Context Movie {
  Aggregate Movie;
}

Aggregate Movie {
  Entity Movie, Actor, Publisher;
}

Entity Movie { }
Entity Actor { }
Entity Publisher { }

Context User {
  Aggregate User;
}

Aggregate User {
  Entity User;
}

Entity User {
}

Entity Payment {
}

ValueObject Price { }
ValueObject Notifications { }
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="chapter-2---binding-implementation"><a class="header" href="#chapter-2---binding-implementation">Chapter 2 - Binding Implementation</a></h1>
<p>本节需要结合 IDEA 插件使用：<a href="https://plugins.jetbrains.com/plugin/20026-feakin"><img src="https://img.shields.io/jetbrains/plugin/v/20026-feakin.svg" alt="Version" /></a></p>
<p><img src="guide/../images/idea/binding-sample.png" alt="" /></p>
<p>编写后 Binding 之后，在左侧点击 <code>Run 'Gen'</code> 即可生成代码。</p>
<h2 id="implementation-domainevent"><a class="header" href="#implementation-domainevent">Implementation DomainEvent</a></h2>
<p>创建 API 时，需要绑定领域事件到实现。</p>
<pre><code class="language-feakin">impl UserCreated {
    endpoint {
        POST &quot;/user/{id}&quot;;
        authorization: Basic admin admin;
        response: User;
    }

    flow {
        via UserRepository::getUserById receive user: User
        via UserRepository::save(user: User) receive user: User;
        via Kafak send User to &quot;user.create&quot;;
    }
}
</code></pre>
<h2 id="layered-implementation"><a class="header" href="#layered-implementation">Layered Implementation</a></h2>
<p>在配置了如下的分层之后，将直接添加到 Controller 中：</p>
<pre><code class="language-feakin">layered DDD {
    dependency {
        &quot;interface&quot; -&gt; &quot;application&quot;
        &quot;interface&quot; -&gt; &quot;domain&quot;
        &quot;domain&quot; -&gt; &quot;application&quot;
        &quot;application&quot; -&gt; &quot;infrastructure&quot;
        &quot;interface&quot; -&gt; &quot;infrastructure&quot;
    }
    layer interface {
        package: &quot;com.feakin.demo.rest&quot;;
    }
    layer domain {
        package: &quot;com.feakin.demo.domain&quot;;
    }
    layer application {
        package: &quot;com.feakin.demo.application&quot;;
    }
    layer infrastructure {
        package: &quot;com.feakin.demo.infrastructure&quot;;
    }
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="code-generator"><a class="header" href="#code-generator">Code Generator</a></h1>
<blockquote>
<p>code generator for fklang</p>
</blockquote>
<p>Download from: <a href="https://github.com/feakin/fklang/releases">https://github.com/feakin/fklang/releases</a></p>
<pre><code class="language-bash">Feakin is a architecture design and visual collaboration tool. This is the parser for Feakin.

Usage: fkl &lt;COMMAND&gt;

Commands:
  dot   generate Graphviz/Dot from fkl file
  ast   generate ast from fkl file
  gen   generate code from fkl file
  run   run function from fkl file
  help  Print this message or the help of the given subcommand(s)

Options:
  -h, --help     Print help information
  -V, --version  Print version information
</code></pre>
<h2 id="basic-generate-method"><a class="header" href="#basic-generate-method">Basic: generate method</a></h2>
<p>sample code:</p>
<pre><code class="language-feakin">impl HelloGot {
    endpoint {
        GET &quot;/hello&quot;;
        response: String;
    }
}
</code></pre>
<p>output:</p>
<pre><code class="language-java">@GetMapping(&quot;/hello&quot;)
public String gotHello() {

}
</code></pre>
<h2 id="auto-insert-aggregate-and-layered"><a class="header" href="#auto-insert-aggregate-and-layered">Auto insert: Aggregate and Layered</a></h2>
<p>declaration with aggregate and layered:</p>
<pre><code class="language-feakin">impl HelloGot {
    aggregate: Hello; // here
    endpoint {
        GET &quot;/hello&quot;;
        response: String;
    }
}

layered DDD {
    layer interface {
        package: &quot;com.feakin.demo.rest&quot;;
    }
    layer domain {
        package: &quot;com.feakin.demo.domain&quot;;
    }
    layer application {
        package: &quot;com.feakin.demo.application&quot;;
    }
    layer infrastructure {
        package: &quot;com.feakin.demo.infrastructure&quot;;
    }
}
</code></pre>
<p>with insert code to: <code>src/main/java/com/feakin/demo/rest/Controller.java</code></p>
<pre><code class="language-java">@GetMapping(&quot;/hello&quot;)
public String gotHello() {

}
</code></pre>
<p>在生成代码时，会先检查已有的 Event 是否存在于 Controller 中，如果存在则报错，如果不存在则自动插入。</p>
<p>过程：</p>
<ol>
<li>使用 TreeSitter 解析目标源码，生成 AST</li>
<li>查找对应生成的方法是否已经存在</li>
</ol>
<h2 id="test-with-http-request"><a class="header" href="#test-with-http-request">Test with Http Request</a></h2>
<p>编写用例：</p>
<pre><code class="language-feakin">impl GitHubOpened {
    endpoint {
        GET &quot;https://book.feakin.com/&quot;;
        response: String;
    }
}

impl FeakinJson {
    endpoint {
        GET &quot;https://raw.githubusercontent.com/feakin/vscode-feakin/master/package.json&quot;;
        response: String;
    }
}
</code></pre>
<p>测试：</p>
<p><img src="guide/../images/idea/endpoint-sample.png" alt="" /></p>
<p>点击 <code>endpoint</code> 左侧的运行按钮，即可运行用例。</p>
<p>Run by Cli</p>
<pre><code class="language-bash">$ fkl run --main ./test_data/cli/impl.fkl --impl GitHubOpened --func request
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="architecture-guarding"><a class="header" href="#architecture-guarding">Architecture Guarding</a></h1>
<h2 id="分层架构守护"><a class="header" href="#分层架构守护">分层架构守护</a></h2>
<pre><code class="language-feakin">layered DDD {
    dependency {
        &quot;interface&quot; -&gt; &quot;application&quot;
        &quot;interface&quot; -&gt; &quot;domain&quot;
        &quot;domain&quot; -&gt; &quot;application&quot;
        &quot;application&quot; -&gt; &quot;infrastructure&quot;
        &quot;interface&quot; -&gt; &quot;infrastructure&quot;
    }
    layer interface {
        package: &quot;com.feakin.demo.rest&quot;;
    }
    layer domain {
        package: &quot;com.feakin.demo.domain&quot;;
    }
    layer application {
        package: &quot;com.feakin.demo.application&quot;;
    }
    layer infrastructure {
        package: &quot;com.feakin.demo.infrastructure&quot;;
    }
}
</code></pre>
<p>Run by IDE:</p>
<p><img src="guide/../images/idea/guard-sample.png" alt="Guarding" /></p>
<p>点击 <code>Guard</code> 按钮，会自动检查依赖是否符合预期。</p>
<p>Run by CLI:</p>
<pre><code class="language-bash">$ fkl run --main ./test_data/cli/impl.fkl --func guarding
</code></pre>
<h2 id="更多守护规则tbd"><a class="header" href="#更多守护规则tbd">更多守护规则（TBD）</a></h2>
<p>refs: <a href="https://github.com/modernizing/guarding">Guarding</a></p>
<pre><code class="language-guarding">class(implementation &quot;BaseParser&quot;)::name should endsWith &quot;Parser&quot;;

class(&quot;java.util.Map&quot;) only accessed([&quot;com.phodal.pepper.refactor.staticclass&quot;]);
class(implementation &quot;BaseParser&quot;)::name should not contains &quot;Lexer&quot;;
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="chapter-5---http-api-verify-tbd"><a class="header" href="#chapter-5---http-api-verify-tbd">Chapter 5 - HTTP API verify (TBD)</a></h1>
<h2 id="契约驱动的-http-api-tbd"><a class="header" href="#契约驱动的-http-api-tbd">契约驱动的 HTTP API （TBD)</a></h2>
<ul>
<li>HTTP API 测试集成</li>
<li>先验条件</li>
<li>后验条件</li>
</ul>
<pre><code class="language-feakin">impl GitHubOpened {
    endpoint {
        GET &quot;https://book.feakin.com/&quot;;
        response: String;
    }
}

impl FeakinJson {
    endpoint {
        GET &quot;https://raw.githubusercontent.com/feakin/vscode-feakin/master/package.json&quot;;
        response: String;
    }
}
</code></pre>
<p>Run by Cli</p>
<pre><code>$ fkl run --main ./test_data/cli/impl.fkl --impl GitHubOpened --func http-request
</code></pre>
<h2 id="校验机制"><a class="header" href="#校验机制">校验机制</a></h2>
<div style="break-before: page; page-break-before: always;"></div><h1 id="chapter-6---mock-server"><a class="header" href="#chapter-6---mock-server">Chapter 6 - Mock Server</a></h1>
<p>Run by CLI:</p>
<pre><code class="language-bash">$ fkl run --main docs/samples/impl.fkl  --func mock-server --env Local
</code></pre>
<p>Run by IDE:</p>
<p><img src="guide/../images/idea/mock-server.png" alt="Mock Server" /></p>
<h2 id="api-mock-server"><a class="header" href="#api-mock-server">API Mock Server</a></h2>
<p>Feakin 通过 Mock Server 来模拟 API 的返回结果，以便于前端开发人员在没有后端 API 的情况下进行开发。</p>
<p>处理逻辑：</p>
<ol>
<li>从 Feakin 项目中读取 Struct 的定义：<code>context</code> -&gt; <code>aggregate</code> -&gt; <code>entity</code></li>
<li>解析 Struct 的定义，生成对应的 Builtin Type</li>
<li>转换 Builtin Type 为 Mock Type</li>
<li>根据 Mock Type 生成 Fake Values</li>
<li>返回 Response</li>
</ol>
<h3 id="builtin-type"><a class="header" href="#builtin-type">Builtin Type</a></h3>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>#[derive(Serialize, Deserialize, Debug, Clone, PartialEq, Eq)]
pub enum BuiltinType {
  Any,
  String,
  Integer,
  Float,
  Boolean,
  Date,
  DateTime,
  Timestamp,
  Array(Vec&lt;BuiltinType&gt;),
  Map(HashMap&lt;String, BuiltinType&gt;),
  Special(String),
}
<span class="boring">}
</span></code></pre></pre>
<h3 id="mock-type"><a class="header" href="#mock-type">Mock Type</a></h3>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>#[derive(Deserialize, Debug, Clone, PartialEq)]
pub enum MockType {
  Null,
  // Optional(Box&lt;MockType&gt;),
  /// basic type
  Unknown(String),
  String(String),
  Integer(i64),
  Float(f64),
  Boolean(bool),
  /// structural type
  Array(Vec&lt;MockType&gt;),
  Map(IndexMap&lt;String, MockType&gt;),
  // additional type
  Date(String),
  DateTime(String),
  Timestamp(i64),
  Uuid(String),
}
<span class="boring">}
</span></code></pre></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="chapter-7---environment"><a class="header" href="#chapter-7---environment">Chapter 7 - Environment</a></h1>
<h2 id="env"><a class="header" href="#env">Env</a></h2>
<p>测试数据库连接</p>
<pre><code class="language-bash">$ fkl run --main docs/samples/impl.fkl  --func test-connection --env Local
</code></pre>
<pre><code class="language-feakin">env Local {
    datasource {
        driver: postgresql
        host: &quot;localhost&quot;
        port: 5432
        database: &quot;test&quot;
    }
    server {
        port: 9090;
    }
}

env Staging {
    // URL 模式
    datasource {
        url: &quot;mysql://localhost:3306/test&quot;
    }
}
</code></pre>
<h2 id="自定义环境变量"><a class="header" href="#自定义环境变量">自定义环境变量</a></h2>
<pre><code class="language-feakin">
env Local {
    kafka {
        host: &quot;localhost&quot;
        port: 9092
    }
}
</code></pre>
<h2 id="环境检查"><a class="header" href="#环境检查">环境检查</a></h2>
<p>verify-env</p>
<p>检查当前环境是否配置正确 ？</p>
<pre><code class="language-bash">
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="fklang-specification"><a class="header" href="#fklang-specification">Fklang Specification</a></h1>
<blockquote>
<p>Fklang provide a two-way binding between design-implementation for architecture.</p>
</blockquote>
<p>Basic Works:</p>
<ul>
<li>DDD syntax. DDD strategy and tactic description.</li>
<li>DomainEvent Implementation. for generate implementation of DomainEvent.</li>
<li>Binding. mapping DSL to SourceCode</li>
<li>Layered syntax. layered structured syntax.</li>
</ul>
<p>In dev:</p>
<ul>
<li>Env for Database.</li>
<li>SourceSet Plugin. third-part integration, like PlantUml, Swagger.</li>
</ul>
<p>Bootstrapping:</p>
<ul>
<li>Builtin Types. like Context, Container, or else.</li>
<li>Description syntax. description design in fake code.</li>
<li>Typedef (TBD). for DDD syntax type bootstrapping.</li>
</ul>
<h2 id="basic-syntax"><a class="header" href="#basic-syntax">Basic Syntax</a></h2>
<p>关键词基本命名规则：</p>
<ul>
<li>DDD 关键词以大写开头，驼峰式命名</li>
<li>其他以小写开头，避免驼峰</li>
<li>特殊场景，遵循该领域的命名规则（但是，应该支持全小写）
<ul>
<li>例外场景 1：HTTP 请求方法，使用全大写</li>
</ul>
</li>
</ul>
<h3 id="assign"><a class="header" href="#assign">assign</a></h3>
<pre><code>attr_type: attr_value;
</code></pre>
<p>example:</p>
<pre><code class="language-feakin">request: CinemaUpdatedRequest;
</code></pre>
<h3 id="declare"><a class="header" href="#declare">declare</a></h3>
<pre><code>Keyword IDENTIFIER (COMMA  IDENTIFIER)*;
</code></pre>
<p>example</p>
<pre><code class="language-feakin">Aggregate Ticket {
  Entity Ticket, Seat;
}
</code></pre>
<h2 id="ddd"><a class="header" href="#ddd">DDD</a></h2>
<p>DDD Syntax:</p>
<table><thead><tr><th>decl</th><th></th><th>usage</th></tr></thead><tbody>
<tr><td>context_map_decl</td><td>:</td><td>[ 'ContextMap' ] [ ID ] '{' (context_node_decl | context_node_rel ) '}'</td></tr>
<tr><td></td><td>|</td><td>att_list</td></tr>
<tr><td>context_node_decl</td><td>:</td><td>['context'] [ID]</td></tr>
<tr><td>context_node_rel</td><td>:</td><td>[ ID ] rel_symbol [ ID ]</td></tr>
<tr><td>rel_symbol</td><td>:</td><td>('-&gt;' | '&lt;-' | '&lt;-&gt;')</td></tr>
<tr><td>context_decl</td><td>:</td><td>[ 'Context' ] [ ID ] '{' aggregate_list? '}'</td></tr>
<tr><td></td><td>|</td><td>att_list</td></tr>
<tr><td>att_list</td><td>:</td><td>attr_item+</td></tr>
<tr><td>attr_item</td><td>:</td><td>([ ID ] '=' [ value ] ','?)* ';'?</td></tr>
<tr><td></td><td>|</td><td>([ ID ] ':' [ value ] ','?)* ';'?</td></tr>
<tr><td></td><td>|</td><td>[ ID ] ([ value, ',' ])*     ';'?</td></tr>
<tr><td>aggregate_decl</td><td>:</td><td>[ 'Aggregate' ]  [ ID ] '{' entity_list '}'</td></tr>
<tr><td></td><td>|</td><td>att_list</td></tr>
<tr><td>entity_decl</td><td>:</td><td>[ 'Entity' ] [ ID ] '{' value_object_list '}'</td></tr>
<tr><td></td><td>|</td><td>att_list</td></tr>
<tr><td>value_object__decl</td><td>:</td><td>[ 'ValueObject' ] [ ID ] '{' value_list '}'</td></tr>
<tr><td></td><td>|</td><td>att_list</td></tr>
</tbody></table>
<h3 id="sample"><a class="header" href="#sample">Sample</a></h3>
<pre><code class="language-feakin">ContextMap Ticket {}

Context ShoppingCarContext {}

// render wtih UML styled?
Aggregate Cart {
  &quot;&quot;&quot; inline doc sample
  just-demo for test
  &quot;&quot;&quot;
  DomainEvent CartCreated, CartItemAdded, CartItemRemoved, CartItemQuantityChanged, CartCheckedOut;
  DomainEvent CartItemQuantityChanged;

  Entity Cart;
}

Entity Cart {
  // it's to many, can change in different way.
  ValueObject CartId
  ValueObject CartStatus
  ValueObject CartItem
  ValueObject CartItemQuantity
  ValueObject CartItemPrice
  ValueObject CartItemTotal
  ValueObject CartTotal
}
</code></pre>
<h2 id="domainevent-implementation"><a class="header" href="#domainevent-implementation">DomainEvent Implementation</a></h2>
<p>Subscribe / Publish / Event / Flow</p>
<h3 id="api"><a class="header" href="#api">API</a></h3>
<ul>
<li>input -&gt; request
<ul>
<li>pre-validate</li>
</ul>
</li>
<li>output -&gt; response
<ul>
<li>post-validate</li>
</ul>
</li>
<li>process -&gt; flow
<ul>
<li>tasking</li>
</ul>
</li>
</ul>
<p>compare to <code>given-when-then</code>.</p>
<pre><code class="language-feakin">impl CinemaCreated {
  endpoint {
    POST &quot;${uri}/post&quot;;
    request: Request;
    authorization: Basic &quot;{{username}}&quot; &quot;{{password}}&quot;;
  }
  
  // created in ApplicationService
  flow {
    via UserRepository::getUserById() receive user: User
    // send &quot;book.created&quot; to Kafka
    via UserRepository::saveUser(user: User) receive void
    // or
    via UserRepository::save(user: User) receive user: User;
    // message queue
    via MessageQueue send CinemaCreated to &quot;CinemaCreated&quot;
    // http request
    via HTTP::post() send Message to &quot;${uri}/post&quot;
    // grpc Greeter
    via GRPC::Greeter send CinemaCreated to &quot;CinemaCreated&quot;
    // map filter
    when(isUserValid) {
      is true =&gt; {
        // do something
      }
      is false =&gt; {
        // do something
      }
    } 
  }
}
</code></pre>
<p>expect generate code will be:</p>
<pre><code class="language-java">// get_user_by_user_id from JPA
public User getUserByUserId(String userId) {
  return userRepository.findByUserId(userId);
}

// get_user_by_user_id from MyBatis
public User getUserByUserId(String userId) {
  return userMapper.getUserByUserId(userId);
}
</code></pre>
<h2 id="binding"><a class="header" href="#binding">Binding</a></h2>
<blockquote>
<p>Binding provide a way to binding source code to Context</p>
</blockquote>
<pre><code class="language-feakin">Aggregate Ticket {
  DomainEvent TicketCreated, TicketUpdated, TicketDeleted;
}

// or to service ?
impl TicketBinding {
  aggregate: Ticket; 
  endpoint {
    GET &quot;/ticket/{id}&quot;;
    request: GetTicketRequest;
    authorization: Basic admin admin;
    response: Ticket;
  }
}

//define config: ExtraConfig {
//  baseUrl: &quot;/ticket&quot;;
//  language: &quot;Java&quot;;
//  package: &quot;com.phodal.coco&quot;;
//}
</code></pre>
<p>If no config, will use default config by scanner?</p>
<h2 id="sourceset-tbd"><a class="header" href="#sourceset-tbd">SourceSet (TBD)</a></h2>
<blockquote>
<p>SourceSet is design for support 3rd-party dsl, like PlantUML, Swagger.yaml</p>
</blockquote>
<table><thead><tr><th>decl</th><th></th><th>usage</th></tr></thead><tbody>
<tr><td>source_set_decl</td><td>:</td><td>simple_source_set_decl</td></tr>
<tr><td></td><td>|</td><td>space_source_set_decl</td></tr>
<tr><td>space_source_set_decl</td><td>:</td><td>[ 'SourceSet' ] [ ID ] '{' att_list '}'</td></tr>
<tr><td>simple_source_set_decl</td><td>:</td><td>[ 'SourceSet' ] [ ID ] '(' att_list ')'</td></tr>
<tr><td>implementation_decl</td><td>:</td><td>[ 'impl' ] [ID] '{' (inline_doc) '}'</td></tr>
</tbody></table>
<h3 id="plantuml-for-structure"><a class="header" href="#plantuml-for-structure">PlantUML for Structure</a></h3>
<p>file_type: uml, puml</p>
<pre><code class="language-feakin">SourceSet sourceSet {
  feakin {
    srcDir: [&quot;src/main/resources/uml&quot;]
  }
  puml {
    parser: &quot;PlantUML&quot;
    srcDir: [&quot;src/main/resources/uml&quot;]
  }
}
</code></pre>
<h3 id="swagger-api-tbd"><a class="header" href="#swagger-api-tbd">Swagger API (TBD)</a></h3>
<p>file_type: Yaml, JSON</p>
<p>with: XPath</p>
<p>refs:</p>
<ul>
<li>xpath syntax: <a href="https://github.com/antlr/grammars-v4/blob/master/xpath/xpath31/XPath31.g4">https://github.com/antlr/grammars-v4/blob/master/xpath/xpath31/XPath31.g4</a></li>
</ul>
<p>//</p>
<pre><code class="language-feakin">SourceSet petSwagger {
  swagger {
    parser: &quot;Swagger&quot;
    srcDir: [&quot;src/main/resources/swagger&quot;]
    xpath: &quot;/definitions/Pet&quot;
  }
}

// with XPath
</code></pre>
<h3 id="uniquelanguage-model--tbd"><a class="header" href="#uniquelanguage-model--tbd">UniqueLanguage model ? (TBD)</a></h3>
<p>file_type: CSV, JSON, Markdown ?</p>
<pre><code class="language-feakin">SourceSet TicketLang {
  UniqueLanguage {
    srcDir: &quot;ticket.csv&quot;;
    type: UniqueLanguage;
    prefix: &quot;Ticket&quot;;
  }
}
</code></pre>
<h2 id="layered"><a class="header" href="#layered">Layered</a></h2>
<blockquote>
<p>Layered is design for decl</p>
</blockquote>
<table><thead><tr><th>decl</th><th></th><th>usage</th></tr></thead><tbody>
<tr><td>layered_decl</td><td>:</td><td>'layered' ([ ID ] | 'default' )  '{' layered_body? '}'</td></tr>
<tr><td>layered_body</td><td>:</td><td>layer_dependency</td></tr>
<tr><td></td><td>|</td><td>layer_item_decl</td></tr>
<tr><td>layer_item_decl</td><td>:</td><td>'layer' [ ID ] '{' layer_item_entry* '}'</td></tr>
<tr><td>layer_item_entry</td><td>:</td><td>package_decl</td></tr>
<tr><td>package_decl</td><td>:</td><td>'package' ':' [ string ]</td></tr>
</tbody></table>
<p>can be guarding for model</p>
<pre><code class="language-feakin">layered DDD {
  dependency {
    &quot;interface&quot; -&gt; &quot;application&quot;
    &quot;interface&quot; -&gt; &quot;domain&quot;
    &quot;domain&quot; -&gt; &quot;application&quot;
    &quot;application&quot; -&gt; &quot;infrastructure&quot;
    &quot;interface&quot; -&gt; &quot;infrastructure&quot;
  }
  layer interface {
     package: &quot;com.example.book&quot;
  }
  layer domain {
     package: &quot;com.example.domain&quot;
  }
  layer application {
    package: &quot;com.example.application&quot;
  }
  layer infrastructure {
    package: &quot;com.example.infrastructure&quot;
  }
}
</code></pre>
<h2 id="env-1"><a class="header" href="#env-1">Env</a></h2>
<p>For database and mock server</p>
<pre><code class="language-feakin">env Local {
  datasource {
    driver: postgresql
    host: &quot;localhost&quot;
    port: 5432
    database: &quot;test&quot;
  }
  server {
    port: 9090;
  }
}
</code></pre>
<h2 id="with-api-testing-todo"><a class="header" href="#with-api-testing-todo">with API testing (Todo)</a></h2>
<p>with Help utils function</p>
<ul>
<li>builtin-functions: mock server</li>
<li>builtin-functions: verify server for testing contract</li>
</ul>
<pre><code class="language-feakin">impl CinemaCreated {
  endpoint {
    GET &quot;/book/{id}&quot;;
    request: CreateBookRequest;
    authorization: Basic admin admin;
    response: Cinema;

    // a mock server for testing
    mock {
       port: 8080;
    };
    verify {
       env: Local;
       expect {
        &quot;status&quot;: 200
        &quot;data&quot;: {
          // build in APIs ?
          &quot;id&quot;: {{$uuid}};
          &quot;price&quot;: {{$randomInt}};
          &quot;ts&quot;: {{$timestamp}};
          &quot;value&quot;: &quot;content&quot;
        }
    }
  }

  // full processing (TBD)
  request CreateBookRequest {
//    schema =&gt; data,
//    schema {
//      &quot;title&quot; : &quot;string&quot;,
//      &quot;author&quot; : &quot;string&quot;,
//      &quot;price&quot; : &quot;number&quot;
//    }
    data {
      &quot;title&quot; : &quot;The Lord of the Rings&quot;,
      &quot;author&quot; : &quot;J.R.R. Tolkien&quot;,
      &quot;price&quot; : 29.99
    }
    validate {
      // title.length &gt; 10 ? 
      title  {
        required { min: 3, max: 10 }
        pattern { regex: &quot;^[a-zA-Z0-9]+$&quot; }
        range { min: 1, max: 100 }
      }
    } 
  } 
  
  middle {
    via User get/update/delete/post userId 
    via Kafka send &quot;book.created&quot;
  }

  response CreateBookResponse {
     struct {
        &quot;id&quot; : &quot;number&quot;
     }
     validate  { }
  } 
  
  // with source side (TBD)
  output CreateBookResponse(xpath=&quot;&quot;);
  input CreateBookResponse(sourceSet=&quot;PetSwagger&quot; location=&quot;&quot;);
}


env Local {
  host: &quot;http://localhost:8080&quot;;
}
</code></pre>
<h3 id="default-impl-config-tbd"><a class="header" href="#default-impl-config-tbd">Default impl config (TBD)</a></h3>
<pre><code class="language-feakin">var config: Config {
  language: &quot;feakin&quot;
  framework: &quot;Spring&quot;
  message: &quot;Kafka&quot; 
  dao: &quot;JPA&quot;
  cache: &quot;Redis&quot;
  search: &quot;ElasticSearch&quot;
}
</code></pre>
<h2 id="bootstrapping"><a class="header" href="#bootstrapping">Bootstrapping</a></h2>
<p>Typedef (TBD)</p>
<blockquote>
<p>Typedef provide custom syntax like container or others, can support for bootstrapping DDD syntax.</p>
</blockquote>
<h3 id="buildin-types"><a class="header" href="#buildin-types">BuildIn Types</a></h3>
<p>Basic Types</p>
<table><thead><tr><th>Name</th><th>Description</th></tr></thead><tbody>
<tr><td>identifier</td><td>unique identifier</td></tr>
<tr><td>binary</td><td>Any binary data</td></tr>
<tr><td>bits</td><td>A set of bits or flags</td></tr>
<tr><td>boolean</td><td>&quot;true&quot; or &quot;false&quot;</td></tr>
<tr><td>enumeration</td><td>Enumerated strings</td></tr>
<tr><td>string</td><td>string</td></tr>
<tr><td>number</td><td>Any number, can be float or int</td></tr>
<tr><td>optional ?</td><td>Optional type ?</td></tr>
</tbody></table>
<p>Data Types ?</p>
<table><thead><tr><th>Name</th><th>Description</th></tr></thead><tbody>
<tr><td>Table</td><td>Table data</td></tr>
<tr><td>List</td><td>List data</td></tr>
<tr><td>Map</td><td>Map data</td></tr>
<tr><td>Set</td><td>Set data</td></tr>
<tr><td>Tuple</td><td>Tuple data</td></tr>
<tr><td>Object</td><td>Object data</td></tr>
<tr><td>Array</td><td>Array data</td></tr>
<tr><td>Date</td><td>Date data</td></tr>
<tr><td>Time</td><td>Time data</td></tr>
<tr><td>DateTime</td><td>DateTime data</td></tr>
<tr><td>Duration</td><td>Duration data</td></tr>
<tr><td>Interval</td><td>Interval data</td></tr>
</tbody></table>
<h3 id="variable"><a class="header" href="#variable">Variable</a></h3>
<pre><code class="language-feakin">var source: JavaSource {
  language: &quot;Java&quot;;
  package: &quot;com.phodal.coco&quot;;
}
</code></pre>
<h4 id="container"><a class="header" href="#container">Container</a></h4>
<pre><code class="language-feakin">def ContextMap {
    // todo: parser generator    
}
</code></pre>
<table><thead><tr><th>decl</th><th></th><th>usage</th></tr></thead><tbody>
<tr><td>typedef_decl</td><td>:</td><td>[ 'typedef'] '(' metaType ')' ID '{' (decl_list) '}';</td></tr>
<tr><td>decl_list</td><td>:</td><td>decl_item*</td></tr>
<tr><td>decl_item</td><td>:</td><td>[ID] ':' decl_name</td></tr>
</tbody></table>
<h3 id="expression"><a class="header" href="#expression">Expression</a></h3>
<p>Description Syntax:</p>
<table><thead><tr><th>decl</th><th></th><th>usage</th></tr></thead><tbody>
<tr><td>description_decl</td><td>:</td><td>[ ID ] '{' expr* '}'</td></tr>
<tr><td>expr</td><td>:</td><td>if_expr</td></tr>
<tr><td></td><td>|</td><td>choose_expr</td></tr>
<tr><td></td><td>|</td><td>behavior_expr</td></tr>
<tr><td>if_expr</td><td>:</td><td>[ 'if' ] '(' [ expression ]  ')'</td></tr>
<tr><td>when_expr</td><td>:</td><td>[ 'when' ] '(' [ expression ]  ')'</td></tr>
<tr><td>behavior_expr</td><td>:</td><td>['via'] [ ID ] action [ID]</td></tr>
<tr><td>action</td><td>:</td><td>[ 'get' | 'update' | 'delete' | 'create' |  'send']</td></tr>
</tbody></table>
<pre><code class="language-feakin">var sample: FakeCode {
  // if (and ?) then {} else {}
  when(condition) {
    is condition1 {

    }
    is condition2 {

    }
    else {

    }
  }

  done
  operator: &lt;, &gt;, &gt;=, &lt;=, ==, +, -, *, %, /, ?
  // call
  via Entity send/ receive Event;
}
</code></pre>
<h3 id="function-bootstrapping"><a class="header" href="#function-bootstrapping">Function (Bootstrapping)</a></h3>
<ul>
<li>mock</li>
<li>verify</li>
<li>validate</li>
</ul>
<pre><code class="language-kotlin">mock {

}

func mock(container: MockContainer) {
  // steps
}

fun verify(input: Input, output: Output) {
  // steps
}

fun validate(input: Input, output: Output) {
  // steps
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="development-guide"><a class="header" href="#development-guide">Development Guide</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="setup"><a class="header" href="#setup">Setup</a></h1>
<h2 id="feakin"><a class="header" href="#feakin">Feakin</a></h2>
<p>repo: <a href="https://github.com/feakin/feakin">https://github.com/feakin/feakin</a></p>
<p>Web:</p>
<ol>
<li>Install Node.js</li>
<li>clone repo</li>
<li>install</li>
</ol>
<pre><code class="language-bash">npm install --legacy-peer-deps
</code></pre>
<ol start="4">
<li>start server by nx</li>
</ol>
<pre><code class="language-bash">nx run render:start
</code></pre>
<p>Rust:</p>
<ol>
<li>Install Rust toolchain</li>
</ol>
<pre><code class="language-bash">curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
</code></pre>
<ol start="2">
<li>cd <code>crates</code></li>
</ol>
<h2 id="intellij-idea"><a class="header" href="#intellij-idea">Intellij IDEA</a></h2>
<p>repo: <a href="https://github.com/feakin/intellij-feakin">https://github.com/feakin/intellij-feakin</a></p>
<ol>
<li>Install Intellij IDEA</li>
<li>clone repo</li>
<li>run <code>./gradlew buildPlugin</code></li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="collaboration"><a class="header" href="#collaboration">Collaboration</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="crdt"><a class="header" href="#crdt">CRDT</a></h1>
<h2 id="服务端actix--diamond-types--crdt"><a class="header" href="#服务端actix--diamond-types--crdt">服务端：Actix + Diamond Types + CRDT</a></h2>
<p>对于服务端来说，它本身其实也是个客户端，只需要接受客户端生成的 patch 即可，在合并了 patch 之后，将它广播出去即可：</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>let before_version = live.lock().unwrap().version();
after_version = self.ops_by_patches(agent_name, patches).await;
// or let after_version = self.insert(content, pos).await;
// or after_version = self.delete(range).await;
let patch = coding.patch_since(&amp;before_version);
<span class="boring">}
</span></code></pre></pre>
<p>Feakin，当前版本在这里，除了支持 patch，还可以同时支持 ins、del 这样的操。核心的代码就这么几行，剩下的代码都是 CRUD，没啥好玩的。</p>
<h2 id="客户端编辑生成-patches"><a class="header" href="#客户端编辑生成-patches">客户端：编辑生成 patches</a></h2>
<p>从结果代码来说，这部分相当的简单：：</p>
<pre><code class="language-javascript">let localVersion = doc.getLocalVersion();
event.changes.sort((change1, change2) =&gt; change2.rangeOffset - change1.rangeOffset).forEach(change =&gt; {
  doc.ins(change.rangeOffset, change.text);
  doc.del(change.rangeOffset, change.rangeLength);
})
let patch = doc.getPatchSince(localVersion);
</code></pre>
<p>由于在前端中 Feakin 采用的是 monaco 的实现，需要在发生变更时，执行 <code>ins</code> 和 <code>del</code> 等，以生成 patch。</p>
<h2 id="客户端编辑器应用-patches"><a class="header" href="#客户端编辑器应用-patches">客户端：编辑器应用 patches</a></h2>
<p>对于客户端来说，接受 patch 并应用也不复杂，然而我被坑了一晚上（被坑在了如何动态更新 Monaco 的模型上）：</p>
<pre><code class="language-javascript">let merge_version = doc.mergeBytes(bytes)
doc.mergeVersions(doc.getLocalVersion(), merge_version);

let xfSinces: DTOperation[] = doc.xfSince(patchInfo.before);
xfSinces.forEach((op) =&gt; {
   ...
});        
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="graph"><a class="header" href="#graph">Graph</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="graph-gim"><a class="header" href="#graph-gim">Graph GIM</a></h1>
<p>see in: <a href="https://github.com/feakin/feakin/blob/master/packages/exporter/src/model/graph.ts">graph.ts</a></p>
<pre><code class="language-typescript">export interface Graph {
  nodes: Node[];
  edges: Edge[];
  props?: GraphProperty;
  subgraphs?: Graph[];
}

export interface Node {
  id: string;
  label: string;
  x?: number;
  y?: number;
  width?: number;
  height?: number;
  subgraph?: boolean;

  data?: NodeData;
  props?: ElementProperty;
}

export interface Edge {
  id: string;
  label?: string;
  points: Point[];

  width?: number;
  height?: number;

  // like beziere curve need a cp
  controlPoints?: Point[];

  data?: EdgeData;

  props?: EdgeProperty;
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="graph-exporter"><a class="header" href="#graph-exporter">Graph Exporter</a></h1>
<h2 id="graphviz-wasm"><a class="header" href="#graphviz-wasm">Graphviz WASM</a></h2>
<p><a href="https://github.com/hpcc-systems/hpcc-js-wasm">@hpcc-js/wasm</a> 提供了一个 Graphviz 的 WASM 封装。</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="render"><a class="header" href="#render">Render</a></h1>
<h2 id="konva-canvas"><a class="header" href="#konva-canvas">Konva Canvas</a></h2>
<div style="break-before: page; page-break-before: always;"></div><h1 id="fklang-1"><a class="header" href="#fklang-1">Fklang</a></h1>
<blockquote>
<p>Fklang 是一个架构设计 DSL，通过显性化软件架构设计，以确保软件系统描述与实现的一致性。并在工作流中，内嵌对于 AI 代码生成软件的支持，以构筑完整的开发者体验。</p>
</blockquote>
<p>inspired by: <a href="https://contextmapper.org/docs/context-map/">ContextMap</a> and π-ADL</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="fkl-parser"><a class="header" href="#fkl-parser">FKL Parser</a></h1>
<p>解析器生成器：<a href="https://pest.rs/">https://pest.rs/</a></p>
<p>Pest 在线编辑器：<a href="https://pest.rs/#editor">https://pest.rs/#editor</a></p>
<h2 id="语法"><a class="header" href="#语法">语法</a></h2>
<pre><code class="language-pest">declarations = _{ SOI ~ declaration* ~ EOI }

declaration = {
  include_decl
  | context_map_decl
  | context_decl
  | ext_module_decl
  | aggregate_decl
  | entity_decl
  | value_object_decl
  | struct_decl
  // ddd
  | component_decl
  | implementation_decl
  | layered_decl
  // extension
  | source_sets_decl
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="fklang-code-generator"><a class="header" href="#fklang-code-generator">Fklang Code Generator</a></h1>
<h2 id="java"><a class="header" href="#java">Java</a></h2>
<h2 id="aws-lambda-tbd"><a class="header" href="#aws-lambda-tbd">AWS Lambda (TBD)</a></h2>
<div style="break-before: page; page-break-before: always;"></div><h1 id="fklang-code-binding"><a class="header" href="#fklang-code-binding">Fklang code binding</a></h1>
<p>Whole process:</p>
<ol>
<li>parse Fklang binding syntax, identify the binding target.</li>
<li>parse the target file, identify the binding target. (use Scanner)</li>
<li>generate the binding code, and insert it into the target file.</li>
<li>format the target file?</li>
</ol>
<p>mods:</p>
<ul>
<li>code_meta. metadata of the code, such as the package name, the class name, the function name, etc.</li>
<li>construct. parse source code to code_meta with TreeSitter.</li>
<li>inserter. insert code to source code.</li>
<li>exec. execute the binding process.</li>
</ul>
<h2 id="treesitter"><a class="header" href="#treesitter">TreeSitter</a></h2>
<p>Online playground: <a href="https://tree-sitter.github.io/tree-sitter/playground">https://tree-sitter.github.io/tree-sitter/playground</a></p>
<p>TreeSitter is support <a href="https://tree-sitter.github.io/tree-sitter/using-parsers#pattern-matching-with-queries">Pattern Matching with Queries</a> can use  <a href="https://en.wikipedia.org/wiki/S-expression">S-expression</a> to query the AST.</p>
<h3 id="query-examples"><a class="header" href="#query-examples">Query examples</a></h3>
<p>Java Code:</p>
<pre><code class="language-java">class DateTimeImpl {
    public Date getDate() {
        return new Date();
    }
}
</code></pre>
<p>Query Language:</p>
<pre><code class="language-haskell">(package_declaration
	(scoped_identifier) @package-name)

(import_declaration
	(scoped_identifier) @import-name)

(program
    (class_declaration
	    name: (identifier) @class-name
        interfaces: (super_interfaces (interface_type_list (type_identifier)  @impl-name))?
        body: (class_body (method_declaration
            (modifiers
                (annotation
                  name: (identifier) @annotation.name
                      arguments: (annotation_argument_list)? @annotation.key_values
                )
            )?
            type: (type_identifier) @return-type
            name: (identifier) @function-name
            parameters: (formal_parameters (formal_parameter
              type: (type_identifier) @param-type
                name: (identifier) @param-name
            ))?
          ))?
    )
)
</code></pre>
<p>Output:</p>
<pre><code class="language-ini">program [0, 0] - [6, 0]
  class_declaration [0, 0] - [4, 1]
    name: identifier [0, 6] - [0, 18]
    body: class_body [0, 19] - [4, 1]
      method_declaration [1, 4] - [3, 5]
        modifiers [1, 4] - [1, 10]
        type: type_identifier [1, 11] - [1, 15]
        name: identifier [1, 16] - [1, 23]
        parameters: formal_parameters [1, 23] - [1, 25]
        body: block [1, 26] - [3, 5]
          return_statement [2, 8] - [2, 26]
            object_creation_expression [2, 15] - [2, 25]
              type: type_identifier [2, 19] - [2, 23]
              arguments: argument_list [2, 23] - [2, 25]
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="fklang-build-system"><a class="header" href="#fklang-build-system">Fklang Build System</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="intellij-plugins"><a class="header" href="#intellij-plugins">Intellij Plugins</a></h1>
<p>Main Resources:</p>
<ul>
<li><a href="https://plugins.jetbrains.com/docs/intellij/custom-language-support-tutorial.html">Custom Language</a> (basic concepts of custom language support)</li>
<li><a href="https://github.com/intellij-rust/intellij-rust">Intellij Rust GitHub</a> (A good example of a custom language plugin)</li>
<li><a href="https://www.jetbrains.org/intellij/sdk/docs/welcome.html">Intellij Plugin Development</a></li>
</ul>
<h2 id="define-by-pluginxml"><a class="header" href="#define-by-pluginxml">Define by <code>plugin.xml</code></a></h2>
<p>IDEA </p>
<pre><code class="language-xml">&lt;extensions defaultExtensionNs=&quot;com.intellij&quot;&gt;
    &lt;!-- File-type Factory --&gt;
    &lt;fileType name=&quot;Feakin File&quot;
              language=&quot;Feakin&quot;
              implementationClass=&quot;com.feakin.intellij.FkFileType&quot;
              fieldName=&quot;INSTANCE&quot;
              extensions=&quot;fkl&quot;/&gt;
    &lt;internalFileTemplate name=&quot;Feakin File&quot;/&gt;

    &lt;!-- Parser --&gt;
    &lt;lang.parserDefinition language=&quot;Feakin&quot;
                           implementationClass=&quot;com.feakin.intellij.parser.FkParserDefinition&quot;/&gt;

    &lt;lang.syntaxHighlighter language=&quot;Feakin&quot;
                            implementationClass=&quot;com.feakin.intellij.highlight.FkSyntaxHighlighter&quot;/&gt;

    &lt;lang.psiStructureViewFactory language=&quot;Feakin&quot;
                                  implementationClass=&quot;com.feakin.intellij.structure.FkStructureViewFactory&quot;/&gt;

    &lt;!-- Editor --&gt;
    &lt;extendWordSelectionHandler implementation=&quot;com.feakin.intellij.ide.editor.FkBlockSelectionHandler&quot;/&gt;
    &lt;lang.foldingBuilder language=&quot;Feakin&quot;
                         implementationClass=&quot;com.feakin.intellij.edit.FkFoldingBuilder&quot;/&gt;

    &lt;lang.commenter language=&quot;Feakin&quot; implementationClass=&quot;com.feakin.intellij.completion.FkCommenter&quot;/&gt;
    &lt;lang.braceMatcher language=&quot;Feakin&quot; implementationClass=&quot;com.feakin.intellij.ide.FkBraceMatcher&quot;/&gt;


    &lt;!-- Navigate between useDomainObject and DomainObjectDecl --&gt;
    &lt;indexedRootsProvider implementation=&quot;com.feakin.intellij.indexing.FkIndexableSetContributor&quot;/&gt;

    &lt;stubElementTypeHolder class=&quot;com.feakin.intellij.lexer.FkElementTypes&quot;/&gt;

    &lt;stubIndex implementation=&quot;com.feakin.intellij.resolve.indexes.FkNamedElementIndex&quot;/&gt;
    &lt;stubIndex implementation=&quot;com.feakin.intellij.resolve.indexes.FkGotoClassIndex&quot;/&gt;

    &lt;gotoSymbolContributor implementation=&quot;com.feakin.intellij.ide.navigate.FkGotoSymbolContributor&quot;/&gt;

    &lt;!-- Completion --&gt;
    &lt;completion.contributor language=&quot;Feakin&quot;
                            implementationClass=&quot;com.feakin.intellij.completion.FkKeywordCompletionContributor&quot;
                            id=&quot;FkKeywordCompletionContributor&quot;
                            order=&quot;first&quot;/&gt;


    &lt;!-- Line Marker Providers --&gt;
    &lt;codeInsight.lineMarkerProvider language=&quot;Feakin&quot;
                                    implementationClass=&quot;com.feakin.intellij.linemarkers.FkImplMessageProvider&quot;/&gt;
    &lt;codeInsight.lineMarkerProvider language=&quot;Feakin&quot;
                                    implementationClass=&quot;com.feakin.intellij.linemarkers.FkImplMethodProvider&quot;/&gt;

    &lt;runLineMarkerContributor language=&quot;Feakin&quot;
                              implementationClass=&quot;com.feakin.intellij.linemarkers.FkImplLineMarkerContributor&quot;/&gt;

    &lt;!-- Run Configurations --&gt;
    &lt;configurationType implementation=&quot;com.feakin.intellij.runconfig.FkCommandConfigurationType&quot;/&gt;

    &lt;programRunner implementation=&quot;com.feakin.intellij.runconfig.FkCommandRunner&quot;/&gt;

    &lt;runConfigurationProducer
            implementation=&quot;com.feakin.intellij.runconfig.command.FkRunConfigurationProducer&quot;/&gt;

    &lt;!-- Formatter --&gt;
    &lt;lang.formatter language=&quot;Feakin&quot; implementationClass=&quot;com.feakin.intellij.formatter.FkFormattingModelBuilder&quot;/&gt;

    &lt;!-- Usages Provider --&gt;
    &lt;lang.findUsagesProvider language=&quot;Feakin&quot; implementationClass=&quot;com.feakin.intellij.ide.search.FkFindUsagesProvider&quot;/&gt;
    &lt;findUsagesHandlerFactory implementation=&quot;com.feakin.intellij.ide.search.FkFindUsagesHandlerFactory&quot;/&gt;
    &lt;usageTypeProvider implementation=&quot;com.feakin.intellij.ide.search.FkUsageTypeProvider&quot;/&gt;
&lt;/extensions&gt;
</code></pre>
<h2 id="indexes-with-stub"><a class="header" href="#indexes-with-stub">Indexes with Stub</a></h2>
<p>sample:</p>
<pre><code class="language-bnf">contextMapDeclaration ::= CONTEXT_MAP_KEYWORD IDENTIFIER contextMapBody
{
  implements = [
    &quot;com.feakin.intellij.psi.FkNamedElement&quot;
    &quot;com.feakin.intellij.psi.FkNameIdentifierOwner&quot;
  ]
  mixin = &quot;com.feakin.intellij.stubs.ext.FkContextMapImplMixin&quot;
  stubClass = &quot;com.feakin.intellij.stubs.FkContextMapDeclStub&quot;
  elementTypeFactory = &quot;com.feakin.intellij.stubs.StubImplementationsKt.factory&quot;
}
</code></pre>
<h2 id="reference"><a class="header" href="#reference">Reference</a></h2>
<p>添加 Ctrl/Command + B，需要配置双向 Reference。如：</p>
<ul>
<li>FkContextNameReferenceImpl 用于寻找对应的 FkContextDeclaration</li>
<li>FkContextDeclReferenceImpl 用于寻找对应的 FkContextName</li>
</ul>
<p>配置缓存支持两种方式:</p>
<ul>
<li>通过 <code>stubIndex</code> 与 BNF 中的 <code>stubClass</code> 配置 Stub。</li>
<li>通过 <code>CachedValuesManager.getCachedValue</code> 配置。</li>
</ul>
<h3 id="配置-stubindex-与-bnf-中的-stubclass-配置-stub"><a class="header" href="#配置-stubindex-与-bnf-中的-stubclass-配置-stub">配置 <code>stubIndex</code> 与 BNF 中的 <code>stubClass</code> 配置 Stub</a></h3>
<ol>
<li>在 <code>plugin.xml</code> 中配置 <code>stubIndex</code> 配置缓存元素：</li>
</ol>
<pre><code class="language-java">&lt;stubIndex implementation=&quot;com.feakin.intellij.resolve.indexes.FkNamedElementIndex&quot;/&gt;
</code></pre>
<ol start="2">
<li>从 BNF 中配置 <code>stubClass</code>：</li>
</ol>
<pre><code class="language-bnf">contextDeclaration ::= CONTEXT_KEYWORD IDENTIFIER contextBody
{
  implements = [
    &quot;com.feakin.intellij.psi.FkNamedElement&quot;
    &quot;com.feakin.intellij.psi.FkNameIdentifierOwner&quot;
    &quot;com.feakin.intellij.psi.ext.FkMandatoryReferenceElement&quot;
  ]
  mixin = &quot;com.feakin.intellij.stubs.ext.FkContextDeclarationImplMixin&quot;
  stubClass = &quot;com.feakin.intellij.stubs.FkContextDeclarationStub&quot;
  elementTypeFactory = &quot;com.feakin.intellij.stubs.StubImplementationsKt.factory&quot;
}
</code></pre>
<ol start="3">
<li>实现对应的配置</li>
</ol>
<h2 id="custom-linemarker"><a class="header" href="#custom-linemarker">Custom LineMarker</a></h2>
<p>自定义 LineMarker 的方式有两种：</p>
<ul>
<li>通过 <code>LineMarkerProvider</code> 实现</li>
<li>通过 <code>RunLineMarkerContributor</code> 实现</li>
</ul>
<pre><code class="language-xml">&lt;!-- line marker --&gt;
&lt;codeInsight.lineMarkerProvider language=&quot;Feakin&quot;
                                implementationClass=&quot;com.feakin.intellij.linemarkers.FkImplMessageProvider&quot;/&gt;

&lt;!--  producer --&gt;
&lt;runConfigurationProducer implementation=&quot;com.feakin.intellij.runconfig.command.FkEndpointConfigurationProducer&quot;/&gt;
</code></pre>
<p>在 Intellij Feakin 中，先创建 <code>RunLineMarkerContributor</code> 后，再创建 <code>RunConfigurationProducer</code>，如 <code>GencodeImplConfigurationProducer</code>。</p>
<pre><code class="language-kotlin">class FkCodegenImplLineMarkerContributor : RunLineMarkerContributor() {
    override fun getInfo(element: PsiElement): Info? {
        if (element !is FkImplDeclaration) return null
        val state = GencodeImplConfigurationProducer().findConfig(listOf(element)) ?: return null

        val actions = ExecutorAction.getActions(0)
        return Info(
            AllIcons.RunConfigurations.TestState.Run,
            { state.configurationName },
            *actions
        )
    }
}
</code></pre>
<p>示例：</p>
<pre><code class="language-kotlin">class GencodeImplConfigurationProducer : BaseLazyRunConfigurationProducer&lt;GencodeConfig, FkImplDeclaration&gt;() {
    override val commandName: String = &quot;gen&quot;

    init {
        registerConfigProvider { elements -&gt; createConfigFor&lt;FkImplDeclaration&gt;(elements) }
    }

    private inline fun &lt;reified T : FkImplDeclaration&gt; createConfigFor(
        elements: List&lt;PsiElement&gt;
    ): GencodeConfig? {
        val path = elements.firstOrNull()?.containingFile?.virtualFile?.path ?: return null
        val sourceElement = elements.firstOrNull { it is T } ?: return null
        return GencodeConfig(commandName, path, sourceElement as FkImplDeclaration)
    }

    private fun registerConfigProvider(provider: (List&lt;PsiElement&gt;) -&gt; GencodeConfig?) {
        runConfigProviders.add(provider)
    }
}
</code></pre>
<h2 id="fkcommandline"><a class="header" href="#fkcommandline">FkCommandLine</a></h2>
<p>与 <code>fkl_cli/src/main.rs</code> 中的 <code>Cli::Commands</code> 保持一致：</p>
<pre><code class="language-kotlin">class FkCommandLine(
    var path: String,
    var impl: String,
    private val subcommand: String,
    private val funcName: String = &quot;&quot;,
)
</code></pre>
<h2 id="syntax-bnf"><a class="header" href="#syntax-bnf">Syntax BNF</a></h2>
<p>语法解析，基于 Grammar Kit 来进行解析： <a href="https://github.com/JetBrains/Grammar-Kit">https://github.com/JetBrains/Grammar-Kit</a></p>
<p>官方示例如下：</p>
<pre><code class="language-bnf">root_rule ::= rule_A rule_B rule_C rule_D                // sequence expression
rule_A ::= token | 'or_text' | &quot;another_one&quot;             // choice expression
rule_B ::= [ optional_token ] and_another_one?           // optional expression
rule_C ::= &amp;required !forbidden                          // predicate expression
rule_D ::= { can_use_braces + (and_parens) * }           // grouping and repetition

// Grammar-Kit BNF syntax

{ generate=[psi=&quot;no&quot;] }                                  // top-level global attributes
private left rule_with_modifier ::= '+'                  // rule modifiers
left rule_with_attributes ::= '?' {elementType=rule_D}   // rule attributes

private meta list ::= &lt;&lt;p&gt;&gt; (',' &lt;&lt;p&gt;&gt;) *                // meta rule with parameters
private list_usage ::= &lt;&lt;list rule_D&gt;&gt;                   // meta rule application
</code></pre>
<h2 id="lsp-todo"><a class="header" href="#lsp-todo">LSP (todo)</a></h2>
<div style="break-before: page; page-break-before: always;"></div><h1 id="monaco-editor"><a class="header" href="#monaco-editor">Monaco Editor</a></h1>
<h2 id="custom-language"><a class="header" href="#custom-language">Custom Language</a></h2>
<ul>
<li><a href="https://microsoft.github.io/monaco-editor/monarch.html">Monaco Editor Language Support</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="faq"><a class="header" href="#faq">FAQ</a></h1>
<h2 id="cannot-be-opened-because-the-developer-cannot-be-verified"><a class="header" href="#cannot-be-opened-because-the-developer-cannot-be-verified">cannot be opened because the developer cannot be verified.</a></h2>
<p>refs:</p>
<ul>
<li><a href="https://support.apple.com/zh-cn/HT202491">在 Mac 上安全地打开 App</a></li>
<li><a href="https://support.apple.com/en-us/HT202491">Safely open apps on your Mac</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="contributors"><a class="header" href="#contributors">Contributors</a></h1>
<p>Here is a list of the contributors who have helped to improve fkbook. Big
shout-out to them!</p>
<ul>
<li><a href="https://github.com/phodal">Phodal</a></li>
</ul>
<p>If you feel you're missing from this list, feel free to add yourself in a PR.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        <script type="text/javascript" src="assets/custom.js"></script>
        <script type="text/javascript">
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>
    </body>
</html>
